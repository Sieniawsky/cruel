#!/usr/bin/env node

/* Database generation script */
var _        = require('lodash');
var mongoose = require('mongoose');
var configDB = require('../config/database.js');
var Location = require('../app/models/location');
var added = 0;
var socket;

/* location data */
var data  = [
    {
        name    : 'Toronto',
        city    : 'Toronto',
        country : 'Canada'
    },
    {
        name    : 'Ottawa',
        city    : 'Ottawa',
        country : 'Canada'
    },
    {
        name    : 'Laurier',
        city    : 'Waterloo',
        country : 'Canada'
    },
    {
        name    : 'Western',
        city    : 'London',
        country : 'Canada'
    }
];

if (process.argv.length === 3 && process.argv[2] === 'prod') {
    socket = configDB.prodSocket;
} else {
    socket = configDB.devSocket;
}

/* Close database connection and exit process */
var close = function() {
    mongoose.connection.close(function () {
        if (added != 0) {
            console.log('Database generated, ' + data.length + ' elements added.');
        } else {
            console.log('Database already exists');
        }
        process.exit(0);
    });
};

/* Establish database connection */
mongoose.connect(socket);

Location.find({}, function(err, locations) {
    if (err) return console.error(err);
    if (locations.length === 0) {
        /* Insert location data */
        _.forEach(data, function(location) {
            var l = new Location(location);
            l.save(function(err, loc) {
                if (err) return console.error(err);
                if (_.indexOf(data, location) === data.length-1) {
                    added = data.length;
                    close();
                }
            });
        });
    } else {
        close();
    }
});
